<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="../things-ajax/things-ajax.html">
<link rel="import" href="../things-global-behavior/things-global-behavior.html">
<link rel="import" href="../things-i18n-msg/things-i18n-msg.html">
<link rel="import" href="../things-msg-box-behavior/things-msg-box-behavior.html">

<dom-module id="things-timeline-event-info">
    <template>
        <style>
            :host {
                display: block;
                background-color: var(--things-white-color);
            }

            .event-info {
                margin: auto;
                padding: 20px 10px 10px 10px;
                max-width: 95%;
                text-align: center;
            }

            .event-info img {
                border-radius: 7px;
                border: 1px solid rgba(0, 0, 0, .1);
                margin-bottom: 10px;
                max-width: 100%;
                max-height: 70%;
            }

            .event-info div {
                padding: 3px 0;
                overflow: hidden
            }

            .event-info div label {
                width: 25%;
                float: left;
                text-align: right;
                font-size: 12px;
                color: #999;
                line-height: 1.6;
            }

            .event-info div span {
                width: 71%;
                float: left;
                padding-left: 1%;
                text-align: left;
                font-size: 12px;
                line-height: 1.5
            }

            .btns {
                margin-top: 15px;
                text-align: center;
            }

            #preview {
                height: 300px;
                @apply(--layout-vertical);
            }

            things-scene-view {
                @apply(--layout-flex)
            }

            paper-button {
                @apply(--things-button)
            }

            paper-button.important {
                @apply(--things-button-important)
            }

            @media only all and (max-width:600px) {
                .btns paper-button {
                    padding: 9px 7px 7px 7px;
                    margin: 0 0 5px 0
                }
            }

        </style>

        <div class="event-info">
            <img width="80%" src$="[[computeImgSrc(event.attachment_id)]]" class="shadow" />

            <div class="info-cell">
                <label>
                    <things-i18n-msg msgid="label.status" auto>status</things-i18n-msg>
                </label>
                <span>[[event.status]]</span>
            </div>

            <div class="info-cell">
                <label>
                    <things-i18n-msg msgid="label.creator" auto>creator</things-i18n-msg>
                </label>
                <span>[[event.creator.name]]</span>
            </div>

            <div class="info-cell">
                <label>
                    <things-i18n-msg msgid="label.updater" auto>updater</things-i18n-msg>
                </label>
                <span>[[event.updater.name]]</span>
            </div>
            <template is="dom-if" if={{approverName(event)}}>
                <div class="info-cell">
                    <label>
                        <things-i18n-msg msgid="label.confirmer" auto>confirmer</things-i18n-msg>
                    </label>
                    <span>[[approverName(event)]]</span>
                </div>
            </template>

            <div class="info-cell">
                <label>
                    <things-i18n-msg msgid="label.created-at" auto>created At</things-i18n-msg>
                </label>
                <span>[[event.created_at]]</span>
            </div>

            <div class="info-cell">
                <label>
                    <things-i18n-msg msgid="label.updated-at" auto>updated At</things-i18n-msg>
                </label>
                <span>[[event.updated_at]]</span>
            </div>

            <div class="info-cell">
                <label>
                    <things-i18n-msg msgid="label.variables" auto>variables</things-i18n-msg>
                </label>
                <span>[[variables]]</span>
            </div>
            <template is="dom-if" if={{event.released_at}}>
                <div class="info-cell">
                    <label>
                        <things-i18n-msg msgid="label.released_at" auto>Released At</things-i18n-msg>
                    </label>
                    <span>[[event.released_at]]</span>
                </div>
            </template>
        </div>

        <div class="btns">
            <!--paper-button on-tap="onTapPreview">
                <things-i18n-msg msgid="button.preview" auto>preview</things-i18n-msg>
            </paper-button>
            <paper-button on-tap="onTapHistory" hidden="[[!isReleaseMode]]">
                <things-i18n-msg msgid="button.history" auto>history</things-i18n-msg>
            </paper-button>
            <paper-button class="important" on-tap="onImageDownload">
                <things-i18n-msg msgid="button.image-download" auto>image download</things-i18n-msg>
            </paper-button-->
            <template is="dom-if" if="{{isDesignUser(globals.user)}}">
                <paper-button on-tap="onVersionUp" hidden="[[!isReleaseMode]]">
                    </iron-icon>
                    <things-i18n-msg msgid="button.version-up" auto>version up</things-i18n-msg>
                </paper-button>
                <paper-button on-tap="onTapRequestConfirm" hidden="[[!isEditMode]]">
                    <things-i18n-msg msgid="button.request-release" auto>request release</things-i18n-msg>
                </paper-button>
                <paper-button on-tap="onTapCancelRequestConfirm" hidden="[[!isApprovalMode]]">
                    <things-i18n-msg msgid="button.cancel-request-release" auto>cancel release request</things-i18n-msg>
                </paper-button>
                <paper-button on-tap="onLabelCopy">
                    <things-i18n-msg msgid="button.copy" auto>copy</things-i18n-msg>
                </paper-button>
                <paper-button on-tap="onTapDelete" hidden="[[!isEditMode]]">
                    <things-i18n-msg msgid="button.delete" auto>delete</things-i18n-msg>
                </paper-button>
            </template>

            <template is="dom-if" if="{{isDeployUser(globals.user)}}">
                <paper-button on-tap="onTapConfirm" hidden="[[!isApprovalMode]]">
                    <things-i18n-msg msgid="button.release" auto>release</things-i18n-msg>
                </paper-button>
            </template>
        </div>


        <things-label-copy id="label-copy" object="{{object}}" groups="{{groups}}"></things-label-copy>

        <things-ajax id="version-up" resource-url="[[versionUpUrl]]" method="POST" content-type="application/json">
        </things-ajax>

        <things-ajax id="request-confirm" resource-url="[[requestApprovalUrl]]" method="PUT" content-type="application/json">
        </things-ajax>

        <things-ajax id="cancel-request-confirm" resource-url="[[cancelRequestApprovalUrl]]" method="PUT" content-type="application/json">
        </things-ajax>

        <things-ajax id="confirm" resource-url="[[releaseUrl]]" method="PUT" content-type="application/json">
        </things-ajax>

        <things-ajax id="delete" resource-url="[[deleteUrl]]" method="DELETE" content-type="application/json">
        </things-ajax>
    </template>

    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'things-timeline-event-info',

                behaviors: [
                    Things.GlobalBehavior,
                    Things.MsgBoxBehavior
                ],

                properties: {
                    resourceUrl: {
                        tpe: String,
                        observer: 'resourceUrlChange'
                    },
                    // version up url
                    versionUpUrl: {
                        type: String
                    },
                    // request approval url
                    requestApprovalUrl: {
                        type: String
                    },
                    // cancel request approval url
                    cancelRequestApprovalUrl: {
                        type: String
                    },
                    // release url
                    releaseUrl: {
                        type: String
                    },
                    // delete url
                    deleteUrl: {
                        type: String
                    },
                    object: {
                        notify: true
                    },

                    groups: {
                        notify: true
                    },

                    events: {
                        notify: true
                    },

                    event: {
                        notify: true,
                        observer: 'eventChanged'
                    },

                    model: {
                        notify: true,
                        computed: 'evalModel(object)',
                        observer: 'onModelChange'
                    },

                    isHidden: {
                        type: Boolean
                    },

                    /**
                     * Edit Status
                     */
                    isEditMode: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Approval Status
                     */
                    isApprovalMode: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Release Status
                     */
                    isReleaseMode: {
                        type: Boolean,
                        value: false
                    }
                },

                listeners: {
                    'request-confirm.things-ajax-response': 'refreshCurrentEvent',
                    'cancel-request-confirm.things-ajax-response': 'refreshCurrentEvent',
                    'confirm.things-ajax-response': 'refreshCurrentEvent',
                    'version-up.things-ajax-response': 'refreshCurrentEvent',
                    'delete.things-ajax-response': '_onDeleteLabelSuccess'
                },

                /**
                 * compute all url
                 */
                resourceUrlChange: function(resourceUrl) {
                    // version up url
                    this.versionUpUrl = resourceUrl + '/:id/version_up';
                    // request approval url
                    this.requestApprovalUrl = resourceUrl + '/:id/request_approval'
                        // cancel request approval url
                    this.cancelRequestApprovalUrl = resourceUrl + '/:id/cancel_request_approval'
                        // release url
                    this.releaseUrl = resourceUrl + '/:id/release'
                        // delete url
                    this.deleteUrl = resourceUrl + '/:id'
                },
                /**
                 * 로그인 사용자가 Designer인지
                 */
                isDesignUser: function(user) {
                    return (user && (this.isDeployUser(user) || user.designer_flag));
                },
                /**
                 * 로그인 사용자가 Deploy 권한이 있는지 체크
                 */
                isDeployUser: function(user) {
                    return (user && (user.admin_flag || user.super_user || user.deployer_flag));
                },

                /**
                 * 승인자 이름
                 */
                approverName: function(event) {
                    return event && event.approver ? event.approver.name : '';
                },

                computeImgSrc: function(src) {
                    var src = `${this.globals.baseUrl}/download/${src}`;
                    if (this.event) {
                        src += '?dc=' + this.event.updated_at
                    }

                    return src;
                },

                evalModel: function(object) {
                    if (object && object.model)
                        return eval("(" + object.model + ")");

                    return {
                        components: [],
                        variables: []
                    };
                },

                /**
                 * 모델 변경시
                 */
                onModelChange: function(model) {
                    if (!model.variables)
                        return;

                    this.variables = model.variables.map(function(variable) {
                        return variable.name
                    }).join(', ');
                },

                /**
                 * version changed
                 */
                eventChanged: function(value) {
                    if (value) {
                        this.isEditMode = (value.status == 'EDIT');
                        this.isApprovalMode = (value.status == 'APPROVAL');
                        this.isReleaseMode = (value.status == 'RELEASED');
                    }
                },

                /**
                 * format Date Data
                 */
                formatEventDate: function(date) {
                    if (!date) {
                        return date;
                    } else if (typeof(date) == 'number') {
                        return new Date(date).toISOString().substring(0, 10)
                    } else if (typeof(date) == 'object') {
                        return date.toISOString().substring(0, 10)
                    } else {
                        return date;
                    }
                },

                /**
                 * Preview
                 */
                /*onTapPreview: function(e) {
                  page(`/preview/${this.event.id}`);
                },*/

                /**
                 * 인쇄 이력
                 */
                /*onTapHistory: function(e) {
                  page(`/print-history/${this.event.id}`);
                },*/

                /**
                 * 이미지 다운로드
                 */
                /*onImageDownload: function(e) {
                  var baseUrl = this.get('globals.baseUrl');
                  window.location = baseUrl + '/download/' + this.event.attachment_id;
                },*/

                /**
                 * 승인 요청
                 */
                onTapRequestConfirm: function(e) {
                    this.doTransaction(Things.DataGlobal.t('button.request-confirm'), Things.DataGlobal.t('text.want-to-request-confirm'), 'request-confirm');
                },

                /**
                 * 승인 요청 취소
                 */
                onTapCancelRequestConfirm: function(e) {
                    this.doTransaction(Things.DataGlobal.t('button.cancel-request-confirm'), Things.DataGlobal.t('text.want-to-cancel-request-confirm'), 'cancel-request-confirm');
                },

                onLabelCopy: function() {
                    this.$['label-copy'].openCopyDialog();
                },

                /**
                 * 승인
                 */
                onTapConfirm: function(e) {
                    this.doTransaction(Things.DataGlobal.t('button.confirm'), Things.DataGlobal.t('text.want-to-confirm'), 'confirm');
                },

                /**
                 * 버전 업
                 */
                onVersionUp: function(e) {
                    var eiditingEvents = this.events.filter(function(event) {
                        return event.status.toLowerCase() !== 'released'
                    });
                    if (eiditingEvents && eiditingEvents.length == 0) {
                        this.doTransaction(Things.DataGlobal.t('button.version-up'), Things.DataGlobal.t('text.want-to-version-up'), 'version-up');
                    } else {
                        this.openConfirmMsg({
                            type: 'warning',
                            title: Things.DataGlobal.t('button.version-up'),
                            text: Things.DataGlobal.t('text.can-not-version-up')
                        });
                    }

                },

                /**
                 * 트랜잭션 처리 후 현재 버전 정보 Refresh
                 */
                refreshCurrentEvent: function(e) {
                    this.event = e.detail;
                    this.object = e.detail;
                    page(`/info/${e.detail.id}`);
                },

                /**
                 * 트랜잭션 처리
                 */
                doTransaction: function(tranTitle, tranMsg, ajaxId) {
                    var me = this;

                    this.openConfirmMsg({
                        type: 'info',
                        title: tranTitle,
                        text: tranMsg,
                        showCancelButton: true
                    }, function() {
                        var ajax = me.$[ajaxId];
                        ajax.resourceId = me.event.id;
                        ajax.generateRequest();
                    });
                },
                /**
                 * localhost인지 아닌지에 따라 Develop mode인지 판단
                 */
                isDevelopMode: function() {
                    return window.location.hostname == 'localhost';
                },
                /**
                 * 선택된 버전 삭재
                 */
                onTapDelete: function(e) {
                    this.doTransaction(Things.DataGlobal.t('button.delete'), Things.DataGlobal.t('text.sure-to-delete'), 'delete');
                },
                /**
                 * 라벨 삭제 완료 후
                 */
                _onDeleteLabelSuccess: function(event) {
                    if (this.events.length == 1) {
                        this.object = this.events[0];
                    } else {
                        this.object = this.events[1];
                    }

                    // 1. 라벨 삭제 후 같은 이름의 라벨이 존재하는 경우
                    if (this.events.length > 1) {
                        page(`/info/${this.object.id}`);
                        // 2. 라벨 삭제 후 같은 이름의 라벨이 존재하지 않는 경우
                    } else {
                        page(`/list/${this.object.label_group_id}`);
                    }
                },
            });
        })();

    </script>
</dom-module>
